name: "PR Reminder to Zoho Cliq"

on:
  workflow_dispatch:

jobs:
  pr-reminder:
    runs-on: ubuntu-latest

    steps:
      - name: Set up Node
        uses: actions/setup-node@v3
        with:
          node-version: 18

      - name: Run PR reminder script
        uses: actions/github-script@v7
        env:
          ZOHO_BOT_PRs_REMINDERS_WH_URL: ${{ secrets.ZOHO_BOT_PRs_REMINDERS_WH_URL }}
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const thresholdDays = 1;
            const webhookUrl = process.env.ZOHO_BOT_PRs_REMINDERS_WH_URL;

            const { data: prs } = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open'
            });

            const now = new Date();

            for (const pr of prs) {
              const createdAt = new Date(pr.created_at);
              const ageDays = Math.floor((now - createdAt) / (1000 * 60 * 60 * 24));

              if (ageDays >= thresholdDays) {
                const reviewers = pr.requested_reviewers.map(r => r.login).join(', ') || 'None';

                const payload = {
                  repo: context.repo.repo,
                  title: pr.title,
                  author: pr.user.login,
                  reviewers: reviewers,
                  age: ageDays,
                  url: pr.html_url
                };

                console.log("Sending payload:", JSON.stringify(payload));

                await fetch(webhookUrl, {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify(payload)
                });
              }
            }
