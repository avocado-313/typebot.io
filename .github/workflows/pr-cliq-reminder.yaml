name: "PR Reminder to Zoho Cliq"

on:
  workflow_dispatch:
  schedule:
    - cron: "0 8 * * 1-5"  # daily at 8:00 UTC, Mon-Fri

jobs:
  pr-reminder:
    runs-on: self-hosted

    steps:
      - name: Set up Node
        uses: actions/setup-node@v3
        with:
          node-version: 18

      - name: Run PR reminder script
        uses: actions/github-script@v7
        env:
          ZOHO_BOT_PRs_REMINDERS_WH_URL: ${{ secrets.ZOHO_BOT_PRs_REMINDERS_WH_URL }}
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            // The Threshold of PRs which late more than 3 Days will be sent to Cliq Bot
            const thresholdDays = 3;
            const webhookUrl = process.env.ZOHO_BOT_PRs_REMINDERS_WH_URL;

            const { data: prs } = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open'
            });

            const now = new Date();

            for (const pr of prs) {
              const createdAt = new Date(pr.created_at);
              const ageDays = Math.floor((now - createdAt) / (1000 * 60 * 60 * 24));

              if (ageDays >= thresholdDays) {

                //
                // ===========================================================
                // Reviewer Separation Logic
                // ===========================================================
                //

                //
                // 1. PENDING REVIEWERS
                //

                // Pending individuals (GitHub hasn't received a review yet)
                const pendingIndividualReviewers =
                  pr.requested_reviewers?.map(r => r.login) || [];

                // Pending teams
                const pendingTeamReviewers =
                  pr.requested_teams?.map(t => t.name) || [];

                // Combine pending (teams + individuals)
                const pendingReviewers = [
                  ...pendingIndividualReviewers,
                  ...pendingTeamReviewers,
                ];

                //
                // 2. COMPLETED REVIEWERS (users who submitted a review)
                //

                const { data: reviews } = await github.rest.pulls.listReviews({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  pull_number: pr.number
                });

                // Extract unique reviewer usernames
                const completedReviewers = Array.from(
                  new Set(
                    reviews
                      .map(r => r.user && r.user.login)
                      .filter(Boolean)
                  )
                );

                //
                // ===========================================================
                // Build the final structured payload
                // ===========================================================
                //

                const payload = {
                  repo: context.repo.repo,
                  title: pr.title,
                  author: pr.user.login,
                  age_days: ageDays,
                  url: pr.html_url,

                  pending_reviewers: pendingReviewers.length > 0 ? pendingReviewers : ['None'],
                  completed_reviewers: completedReviewers.length > 0 ? completedReviewers : ['None']
                };

                console.log("Sending payload:", JSON.stringify(payload, null, 2));

                await fetch(webhookUrl, {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify(payload)
                });
              }
            }
